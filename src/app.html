<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="%sveltekit.assets%/favicon.png" />
		<link rel="apple-touch-icon" href="%sveltekit.assets%/icon-192.png" />
		<link rel="manifest" href="%sveltekit.assets%/manifest.json" />
		<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
		<meta name="theme-color" content="#3B82F6" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="apple-mobile-web-app-title" content="Budget" />
		<meta name="mobile-web-app-capable" content="yes" />
		<script>
			// CRITICAL: Apply theme BEFORE any rendering to prevent black screen/flash
			// This runs synchronously before anything else
			(function() {
				var THEME_BACKGROUNDS = {
					'midnight-blue': '#0F172A',
					'emerald-dark': '#0D1117',
					'sunset-orange': '#18181B',
					'royal-purple': '#1A1625',
					'ocean-teal': '#0F1419',
					'rose-pink': '#1A1018',
					'cyber-neon': '#0A0A0F',
					'coffee-brown': '#1C1410',
					'arctic-blue': '#0C1929',
					'dracula': '#282A36'
				};
				var THEME_PRIMARIES = {
					'midnight-blue': '#3B82F6',
					'emerald-dark': '#10B981',
					'sunset-orange': '#F97316',
					'royal-purple': '#8B5CF6',
					'ocean-teal': '#14B8A6',
					'rose-pink': '#EC4899',
					'cyber-neon': '#00FF88',
					'coffee-brown': '#D97706',
					'arctic-blue': '#38BDF8',
					'dracula': '#BD93F9'
				};
				var storedTheme = null;
				try {
					storedTheme = localStorage.getItem('budget-app-theme');
				} catch(e) {}
				var theme = storedTheme || 'midnight-blue';
				var bgColor = THEME_BACKGROUNDS[theme] || '#0F172A';
				var primaryColor = THEME_PRIMARIES[theme] || '#3B82F6';
				
				// Apply theme class immediately
				document.documentElement.classList.add('theme-' + theme);
				
				// Inject critical CSS with correct colors
				document.write('<style id="critical-theme-css">' +
					'html, body { background-color: ' + bgColor + ' !important; }' +
					'.app-loading { background: ' + bgColor + ' !important; }' +
					'.app-loading-spinner { border-top-color: ' + primaryColor + ' !important; }' +
				'</style>');
			})();
		</script>
		<style>
			/* Initial loading state - prevents black screen on cold start */
			.app-loading {
				position: fixed;
				inset: 0;
				background: var(--color-bg-primary, #0F172A);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 9999;
				transition: opacity 0.2s ease-out;
			}
			.app-loading.hidden {
				opacity: 0;
				pointer-events: none;
			}
			.app-loading-spinner {
				width: 40px;
				height: 40px;
				border: 3px solid #334155;
				border-top-color: var(--color-primary, #3B82F6);
				border-radius: 50%;
				animation: spin 0.8s linear infinite;
			}
			@keyframes spin {
				to { transform: rotate(360deg); }
			}
			/* Ensure body has background color immediately */
			html, body {
				background: var(--color-bg-primary, #0F172A);
				margin: 0;
			}
		</style>
		%sveltekit.head%
	</head>
	<body data-sveltekit-preload-data="hover">
		<!-- Loading indicator shown during app hydration -->
		<div id="app-loading" class="app-loading">
			<div class="app-loading-spinner"></div>
		</div>
		<div style="display: contents">%sveltekit.body%</div>
		<script>
			// Hide loading indicator once app is ready
			// Use multiple strategies to ensure it gets hidden
			function hideLoading() {
				var loader = document.getElementById('app-loading');
				if (loader) {
					loader.classList.add('hidden');
					setTimeout(function() { loader.remove(); }, 200);
				}
			}
			// Strategy 1: Hide when DOM is interactive
			if (document.readyState === 'complete' || document.readyState === 'interactive') {
				setTimeout(hideLoading, 100);
			} else {
				document.addEventListener('DOMContentLoaded', function() {
					setTimeout(hideLoading, 100);
				});
			}
			// Strategy 2: Fallback - hide after max 5 seconds (cold start timeout)
			setTimeout(hideLoading, 5000);
			// Strategy 3: Hide when SvelteKit hydration completes
			window.addEventListener('sveltekit:start', hideLoading);
			
			// Strategy 4: Handle iOS app resume from background
			// iOS Safari can freeze the page and show black screen on resume
			document.addEventListener('visibilitychange', function() {
				if (document.visibilityState === 'visible') {
					// Force hide loading (might be stuck from previous state)
					hideLoading();
					// Check if app content is visible, if not, reload
					setTimeout(function() {
						var appContent = document.querySelector('.app-container, main, [data-sveltekit-hydrate]');
						var body = document.body;
						// If body is empty or only has loading element, something went wrong
						if (!appContent && body.children.length < 2) {
							console.log('[App] Detected empty state on resume, reloading...');
							window.location.reload();
						}
					}, 500);
				}
			});
			
			// Strategy 5: Detect page unload and reload issues (iOS PWA fix)
			window.addEventListener('pageshow', function(event) {
				if (event.persisted) {
					// Page was restored from bfcache, hide loading and check state
					hideLoading();
				}
			});
		</script>
	</body>
</html>
